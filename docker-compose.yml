services:
  postgres-jarvis:
    image: postgres:16-alpine
    container_name: postgres-jarvis
    restart: unless-stopped
    environment:
      POSTGRES_DB: jarvis
      POSTGRES_USER: jarvis
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jarvis -d jarvis"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  jarvis:
    build: .
    container_name: jarvis
    restart: unless-stopped
    depends_on:
      postgres-jarvis:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      # Database
      - DATABASE_URL=${DATABASE_URL}

      # Claude API
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-3-5-haiku-20241022}

      # SSH Configuration - configure these for your infrastructure
      - SSH_NEXUS_HOST=${SSH_NEXUS_HOST:-localhost}
      - SSH_NEXUS_USER=${SSH_NEXUS_USER:-root}
      - SSH_NEXUS_KEY_PATH=/app/ssh_key

      - SSH_HOMEASSISTANT_HOST=${SSH_HOMEASSISTANT_HOST:-localhost}
      - SSH_HOMEASSISTANT_USER=${SSH_HOMEASSISTANT_USER:-root}
      - SSH_HOMEASSISTANT_KEY_PATH=/app/ssh_key

      - SSH_OUTPOST_HOST=${SSH_OUTPOST_HOST:-localhost}
      - SSH_OUTPOST_USER=${SSH_OUTPOST_USER:-root}
      - SSH_OUTPOST_KEY_PATH=/app/ssh_key

      # Discord
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - DISCORD_ENABLED=${DISCORD_ENABLED:-true}

      # Security
      - WEBHOOK_AUTH_USERNAME=${WEBHOOK_AUTH_USERNAME:-alertmanager}
      - WEBHOOK_AUTH_PASSWORD=${WEBHOOK_AUTH_PASSWORD}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}

      # Remediation Settings
      - MAX_ATTEMPTS_PER_ALERT=${MAX_ATTEMPTS_PER_ALERT:-3}
      - ATTEMPT_WINDOW_HOURS=${ATTEMPT_WINDOW_HOURS:-24}
      - COMMAND_EXECUTION_TIMEOUT=${COMMAND_EXECUTION_TIMEOUT:-60}

    volumes:
      # SSH key
      - ./ssh_key:/app/ssh_key:ro

      # Optional: Mount config for runtime updates
      - ./app:/app/app:ro

    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.enable=false"

volumes:
  postgres-data:
