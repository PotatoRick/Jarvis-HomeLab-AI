## [4.0.0] - 2025-12-20

### Major: Phase 8 - Reasoning-First Architecture

**"Tools gather information. Claude does the thinking."**

This is a major architectural transformation that changes how Jarvis solves problems. Instead of relying on developer-hardcoded patterns, Jarvis now uses Claude's reasoning to diagnose and fix issues, then learns from successful reasoning to reduce future API costs.

---

### The Problem with v3.x

Version 3.0.0 promised an "Intelligent Investigator" that would reason about problems. But we kept adding hardcoded patterns:
- `ERROR_PATTERNS` dictionary (9 error-to-binary mappings)
- `PACKAGE_MANAGERS` dictionary (7 base image patterns)
- `CASCADE_PATTERNS` in alert_correlator.py (15 patterns)
- `DEPENDENCIES` in alert_correlator.py (18 service mappings)
- Remediation hints in anomaly_detector.py (6 hardcoded suggestions)

When novel problems appeared, Jarvis couldn't solve them because they weren't in the dictionary.

### The Phase 8 Solution

**Tiered Execution Model:**

| Tier | Criteria | What Happens | API Cost |
|------|----------|--------------|----------|
| **1. Cached** | 90%+ confidence, 5+ successes | Execute cached fix directly | **Zero** |
| **2. Hint-Assisted** | 70-90% confidence, 3+ successes | Give Claude the cached solution as hint | **~50%** |
| **3. Full Reasoning** | Novel or low confidence | Full diagnostic + reasoning | **100%** |

**Key Difference:** Patterns come from Claude's successful reasoning, NOT developer hardcoding.

---

### Added

#### Diagnostic Tools (`app/tools/diagnostics.py`)
- **Information-gathering tools that don't decide anything**
- `get_container_diagnostics()` - Health check, Dockerfile, binaries, logs, resources
- `get_service_dependencies()` - Dynamic discovery from compose files, network connections
- `get_system_state()` - Disk, memory, CPU, Docker state, network
- `get_infrastructure_hosts()` - Dynamic host discovery (replaces hardcoded enum)
- `run_diagnostic_command()` - Run arbitrary diagnostic commands

#### Safe Executor (`app/tools/safe_executor.py`)
- **Validates and executes Claude's proposed fixes**
- `apply_dockerfile_patch()` - Apply Dockerfile changes with backup/rollback
- `execute_remediation_plan()` - Multi-step plans with rollback on failure
- `execute_validated_command()` - Single command with validation
- `execute_cleanup_plan()` - Claude-directed disk cleanup

#### Tiered Learning Engine (`app/learning_engine.py`)
- `ExecutionTier` enum: CACHED, HINT_ASSISTED, FULL_REASONING
- `PatternSource` enum: REASONED vs SEEDED (goal: 100% reasoned)
- `get_execution_tier()` - Determine which tier to use for an alert
- `cache_successful_reasoning()` - Cache Claude's reasoning + diagnostics
- `demote_pattern_on_failure()` - Patterns can be demoted, not just promoted
- `get_tier_statistics()` - Monitor tier usage and API savings
- `get_hint_context()` - Build hint context for Tier 2 execution

#### Database Migration (`migrations/v3.14.0_phase8_tiered_caching.sql`)
- New columns: `cached_diagnostics`, `cached_reasoning`, `pattern_source`, `last_failure_reason`
- View `v_tier_statistics` for monitoring tier distribution

#### Anti-Backsliding Guardrails
- Deprecation logging for hardcoded pattern usage
- `get_deprecated_pattern_metrics()` - Track usage of deprecated patterns
- Warning logs when `ERROR_PATTERNS`, `PACKAGE_MANAGERS`, etc. are used
- Goal: These counters trend toward zero over time

### Changed

#### Health Check Remediation (`app/health_check_remediation.py`)
- Added deprecation logging to `_analyze_error()`, `_get_install_command()`, `_locate_dockerfile()`
- Hardcoded patterns still work but log warnings
- Module docstring explains Phase 8 transformation

#### Alert Correlator (`app/alert_correlator.py`)
- Added deprecation logging to DEPENDENCIES and CASCADE_PATTERNS usage
- Added `get_deprecated_pattern_metrics()` for monitoring
- Tracks: dependencies, cascade_patterns, resource_alerts, suffixes usage
- Phase 8 goal: Replace with dynamic dependency discovery

#### Anomaly Detector (`app/anomaly_detector.py`)
- Added deprecation logging to `_get_remediation_hint()`
- Hardcoded hints logged when used
- Phase 8 goal: Claude reasons about diagnostics, not generic hints

#### Runbooks (Phase 8 Diagnostic Format)
Restructured all runbooks from "run these commands" to "gather this data for Claude":
- **ContainerDown.md** - Diagnostic questions for exit codes, dependencies, system state
- **ContainerCrashLoop.md** - Health check diagnostics, base image analysis, Dockerfile location
- **DiskSpaceLow.md** - What's consuming space, Docker resources, log files
- **HighMemoryUsage.md** - Memory consumers, leak detection, OOM history
- **BackupStale.md** - System mapping, failure diagnosis, B2 connectivity
- **WireGuardVPNDown.md** - Both-side diagnostics, handshake analysis
- **FrigateDatabaseError.md** - Database integrity, corruption detection

New runbook structure:
- "Diagnostic Questions for Claude" (what to gather)
- "Information Claude Needs" (data points and why they matter)
- "Claude Should Decide" (reasoning prompts)
- "Common Remediation Actions" (examples, not prescriptions)

#### Phase 8 Metrics Endpoint
- `GET /phase8-metrics` - Monitor migration progress
- Tracks deprecated pattern usage counts
- Shows tiered execution breakdown
- Reports pattern source distribution (reasoned vs seeded)
- Guardrails status reporting

### Migration Notes

1. **Database Migration Required:**
   ```bash
   psql -U jarvis -d jarvis -f migrations/v3.14.0_phase8_tiered_caching.sql
   ```

2. **Breaking Changes:**
   - None - existing functionality preserved with deprecation warnings
   - Hardcoded patterns continue to work during transition

3. **Monitoring:**
   - Watch for `deprecated_hardcoded_pattern_used` log events
   - Query `v_tier_statistics` view for tier distribution
   - Goal: `reasoned_percent` should approach 100%

### Philosophy

> "The right question isn't 'what pattern matches this error?' It's 'what is Claude's diagnosis?'"

Phase 8 Jarvis solves novel problems through reasoning, then learns from success. The hardcoded patterns were training wheels - now Jarvis can ride without them.

---
