## [3.8.0] - 2025-12-01

### Phase 4: Self-Sufficiency Roadmap - Polish & Scale

**"Jarvis now exposes Prometheus metrics for self-monitoring and uses runbooks for structured remediation guidance"**

This release implements Phase 4 of the Self-Sufficiency Roadmap, targeting improvement from 85% to 95%+ success rate through:

1. **Prometheus Metrics Export** - Self-monitoring via `/metrics` endpoint
2. **Runbook Integration** - Structured remediation guidance for Claude

### Added

#### Prometheus Metrics Export
- **New file**: `app/metrics.py` - Prometheus metric definitions and recording
  - `remediation_total` - Counter of remediation attempts by alert and status
  - `pattern_matches` - Counter of pattern cache hits vs API calls
  - `api_calls` - Counter of Claude API calls by model and status
  - `command_executions` - Counter of SSH commands by host and result
  - `alerts_received` - Counter of alerts from Alertmanager
  - `verification_results` - Counter of verification outcomes
  - `proactive_checks` - Counter of proactive monitoring results
  - `rollback_operations` - Counter of rollback attempts
  - `n8n_workflow_executions` - Counter of n8n workflow triggers
  - `remediation_duration` - Histogram of remediation durations
  - `api_call_duration` - Histogram of Claude API latency
  - `ssh_execution_duration` - Histogram of SSH command latency
  - `active_remediations` - Gauge of currently processing alerts
  - `database_connected` - Gauge of database connection status
  - `pattern_count` - Gauge of learned patterns by confidence
  - `queue_depth` - Gauge of queued alerts (degraded mode)
  - `maintenance_mode` - Gauge of maintenance status
  - `proactive_monitor_running` - Gauge of proactive monitor status
  - `build_info` - Info metric with version details
- **New endpoint**: `GET /metrics` - Prometheus-compatible metrics endpoint

**Example Prometheus Configuration:**
```yaml
- job_name: 'jarvis'
  static_configs:
    - targets: ['your-jarvis-host:8000']
```

#### Runbook Integration
- **New file**: `app/runbook_manager.py` - Runbook loading and management
  - `load_runbooks()` - Load all markdown runbooks from directory
  - `get_runbook()` - Retrieve runbook for specific alert type
  - `get_runbook_context()` - Format runbook for Claude system prompt
  - `list_runbooks()` - List all available runbooks
  - `reload()` - Hot reload runbooks without restart
- **New directory**: `runbooks/` - Markdown runbook files
  - `ContainerDown.md` - Container restart and recovery procedures
  - `WireGuardVPNDown.md` - Cross-system VPN troubleshooting
  - `DiskSpaceLow.md` - Disk cleanup and space recovery
  - `HighMemoryUsage.md` - Memory pressure diagnosis and resolution
  - `BackupStale.md` - Backup system troubleshooting
- **New endpoints**:
  - `GET /runbooks` - List all available runbooks
  - `GET /runbooks/{alert_name}` - Get specific runbook details
  - `POST /runbooks/reload` - Hot reload runbooks from disk
- **Claude integration**: Runbooks automatically included in analysis prompts

**Runbook Format:**
```markdown
# AlertName Remediation Runbook

<!-- risk_level: medium -->
<!-- estimated_duration: 5-10 minutes -->

## Overview
Brief description of the alert and its impact.

## Investigation Steps
1. First thing to check
2. Second thing to check

## Common Causes
- Cause 1
- Cause 2

## Remediation Steps
1. Do this first
2. Then this

## Commands
```bash
# Commands Claude can use
docker restart container
```
```

### Changed

- **Claude Agent**: Now includes runbook context in analysis prompts
- **Main Application**: Initializes metrics and runbook manager on startup
- **Dockerfile**: Now copies `runbooks/` directory into container
- **Requirements**: Added `prometheus-client==0.21.0`
- **Version**: Bumped to 3.8.0

### Metrics Recording

Metrics are automatically recorded throughout the remediation pipeline:
- Alert received → `alerts_received` counter incremented
- Remediation complete → `remediation_total` counter + duration histogram
- Pattern used → `pattern_matches` counter (hit/miss)
- API call made → `api_calls` counter + duration histogram
- SSH command executed → `command_executions` counter

### Technical Details

**Metrics Endpoint:**
- Path: `/metrics`
- Format: Prometheus text exposition format
- No authentication required (internal network only)

**Runbook Loading:**
- Default path: `/app/runbooks/` (Docker) or `./runbooks/` (local dev)
- Format: Markdown with optional YAML frontmatter
- Hot reload: `POST /runbooks/reload`

### Migration Notes

1. No database migration required
2. Add Prometheus scrape target for `/metrics` endpoint
3. Optionally add custom runbooks to `runbooks/` directory
4. Rebuild Docker image to include new runbook files

---
