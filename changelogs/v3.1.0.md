## [3.1.0] - 2025-11-29

### Anti-Spam Overhaul

**"From Alert Storm to Calm Notifications"**

This release fixes a critical issue where Jarvis would spam Discord with 40+ escalation messages when an alert kept firing. Now Jarvis intelligently deduplicates alerts and respects cooldown periods.

### Added

#### Fingerprint-Based Deduplication
- **5-minute cooldown** on identical alerts (same Alertmanager fingerprint)
- Prevents reprocessing when Alertmanager sends repeated webhooks for ongoing alerts
- New database table `alert_processing_cache` tracks recently processed fingerprints
- Returns `"status": "deduplicated"` for skipped alerts

#### Escalation Cooldown System
- **4-hour cooldown** after escalating an alert to Discord
- Prevents "escalation snowball" where same alert spams Discord every minute
- New database table `escalation_cooldowns` tracks when alerts were escalated
- **Resolution-aware**: Cooldown clears when alert resolves, so new incidents get escalated
- Silent logging during cooldown (`escalation_skipped_cooldown` event)

### Changed

#### Attempt Counting Fix (Option D)
- `get_attempt_count()` now **excludes escalation-only records** from the count
- Previously: Each escalation incremented the counter, causing infinite escalations
- Now: Only actual remediation attempts (with commands) count toward `max_attempts_per_alert`
- Query filter: `NOT (escalated = TRUE AND commands_executed IS NULL)`

#### Configuration Updates
- `attempt_window_hours` reduced from 24 to **2 hours** (more reasonable window)
- New setting: `fingerprint_cooldown_seconds: 300` (5 minutes)
- New setting: `escalation_cooldown_hours: 4`

### Fixed

- **Discord spam during alert storms**: BackupAgingWarning incident caused 46+ Discord messages in 2 hours
- **Escalation snowball effect**: Each escalation was counting as an "attempt", triggering more escalations
- **Repeated processing of identical alerts**: Same fingerprint was processed every Alertmanager evaluation interval

### Technical Details

#### New Database Tables
```sql
-- Escalation cooldown tracking
CREATE TABLE escalation_cooldowns (
    alert_name VARCHAR(255) NOT NULL,
    alert_instance VARCHAR(255) NOT NULL,
    escalated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(alert_name, alert_instance)
);

-- Fingerprint deduplication cache
CREATE TABLE alert_processing_cache (
    fingerprint VARCHAR(64) NOT NULL UNIQUE,
    alert_name VARCHAR(255),
    alert_instance VARCHAR(255),
    processed_at TIMESTAMP DEFAULT NOW()
);
```

---
