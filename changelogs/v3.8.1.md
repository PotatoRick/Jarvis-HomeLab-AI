## [3.8.1] - 2025-12-06

### Fixed: BackupStale Multi-System Remediation + Frigate Monitoring Enhancement

**"Jarvis now correctly handles BackupStale alerts for all systems and has enhanced Frigate database corruption detection"**

This release includes two major improvements:
1. BackupStale alerts now correctly route to the appropriate host based on the `system` label
2. Enhanced Frigate health monitoring to detect database corruption that prevents event storage

---

### Part 1: BackupStale Multi-System Remediation

This fixes a critical issue where BackupStale alerts were failing with exit code 127 (command not found) because:
1. The Prometheus alert rule had static `remediation_host: skynet` and `remediation_commands` that only applied to homeassistant
2. The database seed patterns had incorrect script paths
3. The `system` label was not being used to derive the correct host and script

### Changed

#### System-Aware Hint Extraction (`app/utils.py`)
- **Enhanced `extract_hints_from_alert()`**: Now detects BackupStale alerts and derives correct `target_host` and `remediation_commands` from the `system` label
- Added `backup_remediation_map` with system-to-script mappings:
  - `homeassistant` -> skynet -> `/home/t1/homelab/scripts/backup/backup_homeassistant_notify.sh`
  - `skynet` -> skynet -> `/home/t1/homelab/scripts/backup/backup_skynet_notify.sh`
  - `nexus` -> nexus -> `/home/jordan/docker/backups/backup_notify.sh`
  - `outpost` -> outpost -> `/opt/burrow/backups/backup_vps_notify.sh`

#### Corrected Database Seed Patterns (`init-db.sql`)
- Fixed all BackupStale patterns with correct script paths
- Now uses separate INSERT statement with `target_host` column explicitly populated
- Added `BackupHealthCheckStale` pattern with correct path

#### Updated Runbook (`runbooks/BackupStale.md`)
- Complete rewrite with system-specific remediation table
- Added data flow diagram explaining metrics vs fix locations
- Clear documentation that `instance` label is misleading (always shows nexus:9100)
- System-specific command sections for each backup type

### Added

- **Migration script**: `migrations/v3.8.1_fix_backup_patterns.sql`
  - Safely updates existing database with correct patterns
  - Clears old failure patterns to give fresh start
  - Includes verification step
- **Prometheus alert reference**: `configs/prometheus_backup_alerts.yml`
  - Reference configuration without misleading static hints
  - Should be deployed to Nexus to replace current BackupStale rules

### Technical Details

The root cause was a mismatch between:
1. **Where metrics come from**: Nexus textfile collector (scraped via node_exporter)
2. **Where the `system` label indicates**: Which backup is stale
3. **Where fixes should run**: Varies by system (skynet, nexus, or outpost)

The static `remediation_host: skynet` label in the Prometheus alert rule was correct for homeassistant backups but wrong for outpost/nexus backups. Now Jarvis dynamically determines the correct host from the `system` label.

### Configuration Updates

#### `.env` additions
```env
# Prometheus & Loki (on Nexus)
PROMETHEUS_URL=http://192.168.0.11:9090
LOKI_URL=http://192.168.0.11:3100

# Verification Settings
VERIFICATION_ENABLED=true
VERIFICATION_MAX_WAIT_SECONDS=120
VERIFICATION_POLL_INTERVAL=10
```

#### `docker-compose.yml` additions
- Added `PROMETHEUS_URL`, `LOKI_URL` environment variables
- Added `VERIFICATION_ENABLED`, `VERIFICATION_MAX_WAIT_SECONDS`, `VERIFICATION_POLL_INTERVAL`

#### Prometheus Alert Rules (on Nexus)
- Updated `BackupStale` and `BackupAgingWarning` alerts to remove static `remediation_host` and `remediation_commands`
- Added notes explaining Jarvis v3.8.1+ handles routing dynamically

### Deployment Steps

1. Apply database migration:
```bash
docker exec -i postgres-jarvis psql -U jarvis -d jarvis < migrations/v3.8.1_fix_backup_patterns.sql
```

2. Rebuild and restart Jarvis with new config:
```bash
cd /home/t1/homelab/projects/ai-remediation-service
docker compose up -d --force-recreate jarvis
```

3. Verify Prometheus connectivity:
```bash
docker exec jarvis curl -s http://192.168.0.11:9090/api/v1/status/runtimeinfo
```

4. Prometheus alert rules have been updated on Nexus (static hints removed)

---

### Part 2: Enhanced Frigate Database Corruption Detection

A Frigate database corruption incident revealed a gap in monitoring: the existing health checks passed (API responding, cameras online) even when the database was corrupted and unable to store new events.

#### Problem
- Frigate SQLite database corruption prevented event storage
- Cameras showed "no events found" despite motion detection working
- Existing monitoring showed "healthy" because API responded with cached data

#### Solution

**1. Enhanced Frigate Health Exporter v2** (`scripts/exporters/frigate_health_exporter.sh`)

New metrics added:
- `frigate_events_api_up` - Direct database access check via `/api/events`
- `frigate_events_recent` - Whether events were recorded in last hour (staleness detection)
- `frigate_events_last_hour` - Count of recent events for trending
- Expanded error pattern matching (8 patterns, last 500 lines)

**2. New Prometheus Alert Rules** (`configs/prometheus/alert_rules.yml`)

```yaml
- alert: FrigateEventsStale
  expr: frigate_events_recent == 0 and frigate_cameras_receiving_frames == 1 and frigate_api_up == 1
  for: 30m
  # Fires when cameras are online but no events recorded for 1+ hour

- alert: FrigateEventsAPIDown
  expr: frigate_events_api_up == 0 and frigate_api_up == 1
  for: 5m
  # Fires when events API fails but main API works (direct DB corruption detection)
```

**3. New Jarvis Runbook** (`runbooks/FrigateDatabaseError.md`)
- Covers FrigateDatabaseError, FrigateEventsAPIDown, FrigateEventsStale, FrigateCamerasNotReceivingFrames
- Investigation steps, common causes, remediation commands
- Verification steps after restart

**4. Docker Compose Update**
- Added `./runbooks:/app/runbooks:ro` volume mount for hot-reload of runbooks

#### Deployment

1. Deploy updated exporter to Nexus:
```bash
scp scripts/exporters/frigate_health_exporter.sh nexus:/opt/exporters/
ssh nexus 'sudo chmod 755 /opt/exporters/frigate_health_exporter.sh'
```

2. Deploy updated alert rules to Nexus:
```bash
scp configs/prometheus/alert_rules.yml nexus:/home/jordan/docker/home-stack/prometheus/
ssh nexus 'docker exec prometheus kill -HUP 1'
```

3. Restart Jarvis to pick up new runbook mount:
```bash
docker compose up -d jarvis
```

#### Additional Fixes in This Session

- **Pydantic v2 Extra Field Access**: Fixed `_get_extra_field()` helper in `utils.py` to properly access `model_extra` dict for extra fields like `system` label
- **Hints Passed to Claude**: Updated `claude_agent.py` to include extracted hints (system, target_host, system_specific_command) in the Claude prompt
- **Skynet Host Added**: Added "skynet" to all 4 host enums in Claude tool definitions
- **Skynet SSH Configuration**: Added `SSH_SKYNET_HOST=192.168.0.13` and `SSH_SKYNET_USER=t1` to `.env` and `docker-compose.yml`
- **Command Timeout Increased**: Raised `COMMAND_EXECUTION_TIMEOUT` from 60 to 300 seconds for backup scripts
- **Self-Protection Pattern Fixed**: Changed broad `.*skynet` pattern to specific `skynet\.service` to allow `skynet-backup.service` restarts
- **Discord Instance Display**: BackupStale alerts now show system name instead of "nexus:9100" in Discord notifications

---
