## [3.9.0] - 2025-12-07

### Added: Self-Preservation Mechanism (Phase 5)

**"Jarvis can now safely restart itself and its dependencies via n8n orchestration"**

This release introduces a self-preservation mechanism that allows Jarvis to safely restart its own container, database, or even the host system without bricking itself. The restart is orchestrated by n8n which handles the handoff, executes the restart, polls until healthy, and resumes any interrupted work.

**Tested and verified working in production** - Full self-restart cycle completed successfully with Discord notifications.

---

### Added

#### Remediation Context Continuation (v3.9.0 Enhancement)
- **Context preservation**: When Jarvis triggers a self-restart mid-remediation, it saves the full context:
  - Alert details (name, instance, fingerprint, severity)
  - Commands already executed with their outputs
  - Claude's analysis and reasoning
  - Target host and service information
- **Automatic continuation**: After restart, Jarvis automatically continues the interrupted remediation
- **Smart resumption**: Claude receives context about what was already done to avoid repeating commands
- **Discord notifications**: Updates sent for continuation progress and results

#### Claude Agent Context Tracking (`app/claude_agent.py`)
- **`set_remediation_context()`**: Sets current remediation state before analysis
- **`update_context_commands()`**: Tracks commands as they're executed
- **`update_context_analysis()`**: Stores Claude's analysis for handoff
- **`get_remediation_context()`**: Retrieves context for serialization
- **`clear_remediation_context()`**: Cleans up after successful completion

#### Background Continuation (`app/main.py`)
- **`continue_interrupted_remediation()`**: Background task that:
  - Reconstructs context from saved state
  - Builds continuation prompt with previous work summary
  - Re-invokes Claude with awareness of what's already been done
  - Executes any new commands needed
  - Notifies Discord of continuation results

#### Self-Preservation Manager (`app/self_preservation.py`)
- **SelfPreservationManager class**: Coordinates safe self-restart operations
- **RemediationContext model**: Serializable state for in-progress remediations
- **SelfPreservationHandoff model**: Tracks handoff lifecycle
- **State serialization**: Saves current remediation state before restart
- **n8n workflow trigger**: Hands off restart to external orchestrator
- **Resume capability**: Continues from saved state after restart

#### New API Endpoints
- **POST `/resume`**: Called by n8n after restart to resume operations
- **POST `/self-restart`**: Initiate self-restart via n8n handoff (requires auth)
- **GET `/self-restart/status`**: Check status of active handoffs
- **POST `/self-restart/cancel`**: Cancel an active handoff

#### Claude Agent Tool
- **`initiate_self_restart` tool**: Allows Claude to request safe self-restarts
- Supports targets: `jarvis`, `postgres-jarvis`, `docker-daemon`, `skynet-host`
- Requires reason for audit trail

#### Command Validator Updates (`app/command_validator.py`)
- **Self-protection awareness**: Recognizes commands targeting Jarvis dependencies
- **Handoff override**: Can allow blocked commands when handoff is active
- **Helpful guidance**: Provides `/self-restart` API instructions when blocking self-restart attempts
- **`SELF_PROTECTION_PATTERNS`**: List of commands that require handoff mechanism

#### n8n Workflow
- **`jarvis-self-restart-workflow.json`**: Complete workflow for self-restart orchestration
- Webhook trigger at `/webhook/jarvis-self-restart`
- SSH execution of restart commands
- Health polling with configurable timeout
- Automatic callback to `/resume` endpoint
- Discord notifications for start, success, and timeout

#### Database Schema
- **`self_preservation_handoffs` table**: Persists handoff state across restarts
- Unique index prevents concurrent handoffs
- Tracks status, context, n8n execution ID, and timestamps

#### Prometheus Metrics (`app/metrics.py`)
- **`jarvis_self_restarts_total`**: Counter for self-restart operations by target and status
- **`jarvis_self_restart_failures_total`**: Counter for failures with specific reason codes
- **`jarvis_self_restart_duration_seconds`**: Histogram of restart duration by target
- **`jarvis_self_restart_active`**: Gauge indicating active handoff (1/0)

#### Runbook (`runbooks/JarvisRestart.md`)
- Comprehensive troubleshooting guide for self-preservation system
- Covers timeout issues, n8n trigger failures, SSH problems
- Includes manual recovery procedures

### Changed

- **main.py lifespan**: Initializes SelfPreservationManager on startup
- **main.py lifespan**: Checks for pending handoffs on startup for recovery
- **n8n_client.py**: Now initializes even without API key (webhook-only mode)
- **n8n workflow**: Added 10-minute execution timeout to prevent runaway executions

### Fixed

- **n8n client initialization**: Fixed variable reference so n8n client is properly passed to SelfPreservationManager
- **Test handoffs**: `/resume` endpoint now accepts test handoff IDs (prefix `test-`) without database record
- **Context tracking during tool execution**: `update_context_commands()` now called for `restart_service` and `execute_safe_command` tools
- **Analysis context preservation**: `update_context_analysis()` now called after Claude returns its analysis
- **Callback URL configuration**: Added `JARVIS_EXTERNAL_URL` setting to ensure n8n can reach Jarvis callback
- **Stale handoff cleanup**: Added `cleanup_stale_handoffs()` method that runs on startup to clear abandoned handoffs

### Technical Details

The self-preservation flow:
1. Claude or API initiates self-restart with target and reason
2. SelfPreservationManager serializes current remediation state to database
   - Captures: alert details, commands executed, outputs, Claude analysis, target host
3. n8n workflow is triggered via webhook with restart details
4. n8n responds immediately with handoff acknowledgment
5. n8n executes restart command via SSH
6. n8n polls Jarvis `/health` endpoint until healthy (10s intervals)
7. n8n calls `/resume` endpoint with handoff_id
8. Jarvis marks handoff complete
9. **If remediation context exists**, Jarvis schedules background continuation:
   - Reconstructs context from saved state
   - Re-invokes Claude with summary of previous work
   - Claude determines if additional actions needed after restart
   - Executes any new commands (avoids repeating already-executed ones)
10. Discord notifications sent at each stage (including continuation results)

### Protected Targets

| Target | Command | Description |
|--------|---------|-------------|
| `jarvis` | `docker restart jarvis` | Jarvis container |
| `postgres-jarvis` | `docker restart postgres-jarvis && sleep 10 && docker restart jarvis` | Database + Jarvis |
| `docker-daemon` | `sudo systemctl restart docker` | Docker service |
| `skynet-host` | `sudo reboot` | Full host reboot |

### Migration

For existing databases, run:
```sql
\i migrations/v3.9.0_self_preservation.sql
```

### Configuration

Ensure these are configured in `.env`:
```env
# n8n integration
N8N_URL=https://n8n.theburrow.casa
N8N_API_KEY=your_api_key  # Optional for webhook-only mode

# Self-preservation (IMPORTANT: must be reachable from n8n host)
JARVIS_EXTERNAL_URL=http://192.168.0.13:8000
SELF_RESTART_TIMEOUT_MINUTES=10
STALE_HANDOFF_CLEANUP_MINUTES=30
```

Import the workflow `configs/n8n-workflows/jarvis-self-restart-workflow.json` into n8n.

Configure SSH credentials in n8n:
- Create credential named `skynet-ssh` with SSH key access to Skynet (192.168.0.13)

---
