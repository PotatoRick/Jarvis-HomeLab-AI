## [3.9.1] - 2025-12-07

### Fixed: QA Review Issues for Phase 5

**Comprehensive fixes from QA review addressing security, reliability, and robustness issues.**

---

### Fixed

#### Critical Issues
- **CRITICAL-002**: Added n8n workflow existence validation on startup - Jarvis now checks if the self-restart webhook is accessible and logs warnings if not (`app/main.py` lifespan)
- **CRITICAL-003**: Added Phase 5 prerequisite health checks on startup - validates JARVIS_EXTERNAL_URL, n8n connectivity, and webhook availability with clear warnings (`app/main.py` lifespan)

#### High Priority Issues
- **HIGH-001**: Added Pydantic validator for `JARVIS_EXTERNAL_URL` with URL format validation and localhost warnings (`app/config.py`)
- **HIGH-002**: Added size limits to `RemediationContext` serialization - prevents database overflow with `MAX_COMMANDS=50`, `MAX_OUTPUT_LENGTH=10KB`, `MAX_ANALYSIS_LENGTH=20KB` (`app/self_preservation.py`)
- **HIGH-003**: Improved n8n error differentiation - `trigger_webhook()` now returns specific error types (`workflow_not_found`, `n8n_server_error`, `n8n_client_error`) for better debugging (`app/n8n_client.py`)
- **HIGH-004**: Fixed potential DB pool exhaustion during stale cleanup - now uses `LIMIT 100` batching to prevent unbounded queries (`app/self_preservation.py`)
- **HIGH-006**: Fixed race condition in concurrent restart requests - now uses PostgreSQL advisory lock (`pg_advisory_xact_lock`) within transaction to ensure atomicity (`app/self_preservation.py`)
- **HIGH-007**: Added Pydantic validators for all Phase 5 configuration with bounds checking for `stale_handoff_cleanup_minutes` (10-1440) and `self_restart_timeout_minutes` (2-60) (`app/config.py`)

#### Medium Priority Issues
- **MEDIUM-003**: Added exception handling wrapper for continuation background task - catches exceptions, logs with full traceback, and sends Discord notification on crash (`app/main.py`)
- **MEDIUM-004**: Added authentication to `/resume` endpoint - now accepts HTTP Basic Auth or `X-Jarvis-Handoff-Token` header (`app/main.py`)
- **MEDIUM-008**: Added restart count tracking to `RemediationContext` to prevent infinite restart loops - defaults to `max_restarts=2` (`app/self_preservation.py`)

### Added

#### n8n Client Enhancements (`app/n8n_client.py`)
- **`check_webhook_exists()`**: Probes webhook URL to verify n8n workflow is active
- **`health_check()`**: Checks n8n API health for startup validation

#### Configuration Validators (`app/config.py`)
- `validate_jarvis_external_url()`: URL format validation with localhost warning
- `validate_stale_handoff_cleanup()`: Bounds checking (10-1440 minutes)
- `validate_self_restart_timeout()`: Bounds checking (2-60 minutes)
- `validate_n8n_url()`: URL format validation with trailing slash normalization

#### RemediationContext Improvements (`app/self_preservation.py`)
- `restart_count` field: Tracks number of restarts for this remediation
- `max_restarts` field: Configurable limit (default 2)
- Size limits constants: `MAX_COMMANDS`, `MAX_OUTPUT_LENGTH`, `MAX_ANALYSIS_LENGTH`
- Safe serialization fallback: Returns minimal context if JSON serialization fails

### Changed

- **Startup flow**: Now validates Phase 5 prerequisites before accepting traffic
- **Stale cleanup**: Uses batched processing instead of unbounded query
- **Self-restart initiation**: Uses database transaction with advisory lock for atomicity
- **Resume endpoint**: Requires authentication (was previously unauthenticated)

---
