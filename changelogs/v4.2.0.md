## [4.2.0] - 2026-01-04

### Claude Code Escalation

**"When safety rules block the fix, escalate to Claude Code with full permissions"**

This release adds automatic escalation to Claude Code CLI when Jarvis's command validator rejects proposed remediation commands. Instead of failing and requiring human intervention, Jarvis can now "break glass" and let Claude Code fix issues directly.

### Added

- **Claude Code escalation** (`app/claude_cli.py`): New `escalate_with_full_permissions()` method that invokes Claude CLI with `--dangerously-skip-permissions` flag
- **Escalation prompt builder**: `_build_escalation_prompt()` provides full context about rejected commands and their rejection reasons
- **Escalation SSH runner**: `_run_escalation_via_ssh()` handles the SSH/SFTP workflow for escalation mode
- **Main.py integration**: When command validator rejects commands, automatically escalates instead of just failing
- **Discord notifications**: Orange "Escalating to Claude Code" notification when escalation starts

### Changed

- **Command rejection flow**: Previously rejected commands would fail immediately; now they trigger escalation
- **Remediation success path**: Escalation success counts as remediation success for logging purposes

### Technical Details

**Escalation Flow:**
```
Alert received
    ↓
Claude API suggests commands (e.g., "sed -i 's/curl/python/' Dockerfile")
    ↓
Command validator rejects ("In-place file edit detected")
    ↓
Escalation triggered
    ↓
Claude Code CLI runs with --dangerously-skip-permissions
    ↓
Claude Code fixes issue directly (full access)
    ↓
Success/failure logged
```

**Key Implementation:**
```python
# When commands rejected, escalate instead of failing
if not validation_result.safe:
    escalation_success, escalation_output = await claude_cli.escalate_with_full_permissions(
        alert_data=escalation_alert_data,
        rejected_commands=validation_result.rejected_commands,
        rejection_reasons=validation_result.rejection_reasons,
        container_logs=container_logs,
    )
```

**Escalation vs Normal Flow:**
| Aspect | Normal Flow | Escalation Flow |
|--------|-------------|-----------------|
| Safety | Regex blacklist | Claude's judgment |
| Speed | ~10-30s | ~60-90s |
| Audit | Commands logged | Session logged |
| Scope | Specific commands | Full access |

### Motivation

The command validator blocks dangerous patterns like `sed -i`, `rm -rf`, etc. for safety. But sometimes these commands are exactly what's needed:

- Fixing a Dockerfile that needs `sed -i` to update a package
- Removing a corrupted file with `rm`
- Editing configuration files in-place

Previously, these situations required human intervention. Now Jarvis can escalate to Claude Code, which uses its own judgment rather than regex patterns to determine safety.

### Configuration

Uses existing CLI mode settings:
```bash
CLAUDE_CLI_PATH=/home/t1/.claude/local/claude
SSH_SKYNET_HOST=192.168.0.13
SSH_SKYNET_USER=t1
```

No additional configuration required.

---
