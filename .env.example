# ═══════════════════════════════════════════════════════════════════════════════
# JARVIS AI REMEDIATION SERVICE - CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
# Copy this file to .env and fill in your values:
#   cp .env.example .env
#
# Or run the interactive setup wizard:
#   ./setup.sh
#
# QUICK START (minimum required):
#   - DATABASE_URL, POSTGRES_PASSWORD
#   - ANTHROPIC_API_KEY
#   - SSH_NEXUS_HOST, SSH_NEXUS_USER, ssh_key file
#   - DISCORD_WEBHOOK_URL (recommended)
#   - WEBHOOK_AUTH_PASSWORD
#
# Documentation: https://github.com/PotatoRick/Jarvis-HomeLab-AI
# ═══════════════════════════════════════════════════════════════════════════════


# ─────────────────────────────────────────────────────────────────────────────
# DATABASE (Required)
# ─────────────────────────────────────────────────────────────────────────────
# PostgreSQL connection string for Jarvis state storage.
# The included docker-compose.yml creates a postgres-jarvis container.
# Use the same password in both DATABASE_URL and POSTGRES_PASSWORD.

DATABASE_URL=postgresql://jarvis:CHANGE_THIS_PASSWORD@postgres-jarvis:5432/jarvis
POSTGRES_PASSWORD=CHANGE_THIS_PASSWORD


# ─────────────────────────────────────────────────────────────────────────────
# CLAUDE API (Required)
# ─────────────────────────────────────────────────────────────────────────────
# Get your API key from: https://console.anthropic.com/
#
# Recommended model: claude-3-5-haiku-20241022 (cost-effective)
# Alternative: claude-sonnet-4-5-20250929 (more capable, higher cost)
#
# Typical costs:
#   - Haiku: ~$0.008 per remediation
#   - Sonnet: ~$0.03 per remediation

ANTHROPIC_API_KEY=sk-ant-api03-YOUR_KEY_HERE
CLAUDE_MODEL=claude-3-5-haiku-20241022


# ─────────────────────────────────────────────────────────────────────────────
# SSH CONFIGURATION (Required - at least primary host)
# ─────────────────────────────────────────────────────────────────────────────
# Jarvis connects via SSH to execute remediation commands on your servers.
#
# Setup SSH key:
#   1. Copy your SSH private key to ./ssh_key
#   2. Set permissions: chmod 600 ./ssh_key
#   3. Ensure the key is authorized on your target servers
#
# Or generate a new key with: ./setup.sh (option to generate during setup)

# Primary host (required) - Your main server running Docker services
SSH_NEXUS_HOST=192.168.1.100
SSH_NEXUS_USER=your_username

# Home Assistant (optional) - For HA addon management and automation reloads
# Set to actual IP/hostname if you want Jarvis to manage Home Assistant
SSH_HOMEASSISTANT_HOST=localhost
SSH_HOMEASSISTANT_USER=root

# Cloud/VPS host (optional) - For managing remote servers
SSH_OUTPOST_HOST=localhost
SSH_OUTPOST_USER=root

# Management host (optional) - Where Jarvis itself runs (for self-management)
# Required if using self-preservation features
SSH_SKYNET_HOST=localhost
SSH_SKYNET_USER=root


# ─────────────────────────────────────────────────────────────────────────────
# DISCORD NOTIFICATIONS (Recommended)
# ─────────────────────────────────────────────────────────────────────────────
# Jarvis sends notifications for:
#   - Successful remediations (green embed)
#   - Failed attempts (orange embed)
#   - Escalations requiring human attention (red embed, @here ping)
#   - Dangerous command rejections (red embed)
#
# Get webhook URL from: Server Settings -> Integrations -> Webhooks

DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN
DISCORD_ENABLED=true


# ─────────────────────────────────────────────────────────────────────────────
# WEBHOOK SECURITY (Required)
# ─────────────────────────────────────────────────────────────────────────────
# Alertmanager authenticates to Jarvis using HTTP basic auth.
# Configure your Alertmanager with these credentials.
#
# Generate a secure password: openssl rand -base64 32

WEBHOOK_AUTH_USERNAME=alertmanager
WEBHOOK_AUTH_PASSWORD=GENERATE_A_SECURE_PASSWORD


# ─────────────────────────────────────────────────────────────────────────────
# REMEDIATION SETTINGS (Optional - sensible defaults)
# ─────────────────────────────────────────────────────────────────────────────
# MAX_ATTEMPTS_PER_ALERT: Number of fix attempts before escalating to human
# ATTEMPT_WINDOW_HOURS: Rolling window for counting attempts
# COMMAND_EXECUTION_TIMEOUT: SSH command timeout in seconds

MAX_ATTEMPTS_PER_ALERT=3
ATTEMPT_WINDOW_HOURS=2
COMMAND_EXECUTION_TIMEOUT=60


# ─────────────────────────────────────────────────────────────────────────────
# ANTI-SPAM SETTINGS (Optional)
# ─────────────────────────────────────────────────────────────────────────────
# Prevents duplicate processing and notification spam

# Don't reprocess the same alert fingerprint within this window
FINGERPRINT_COOLDOWN_SECONDS=300

# Don't re-escalate the same alert within this window
ESCALATION_COOLDOWN_HOURS=4


# ─────────────────────────────────────────────────────────────────────────────
# LOGGING (Optional)
# ─────────────────────────────────────────────────────────────────────────────
# LOG_LEVEL: DEBUG, INFO, WARNING, ERROR
# LOG_FORMAT: json (structured) or text (human-readable)

LOG_LEVEL=INFO
LOG_FORMAT=json


# ═══════════════════════════════════════════════════════════════════════════════
# ADVANCED FEATURES (Full Setup)
# ═══════════════════════════════════════════════════════════════════════════════
# The settings below enable additional capabilities.
# Leave commented/default for Quick Start setup.
# Run ./setup.sh --upgrade to enable these features.


# ─────────────────────────────────────────────────────────────────────────────
# PROMETHEUS & LOKI (Alert verification and log context)
# ─────────────────────────────────────────────────────────────────────────────
# When enabled, Jarvis verifies fixes by checking Prometheus metrics
# and queries Loki for additional log context.

PROMETHEUS_URL=http://localhost:9090
LOKI_URL=http://localhost:3100

# Enable to verify fixes via Prometheus queries (recommended for production)
VERIFICATION_ENABLED=false
VERIFICATION_MAX_WAIT_SECONDS=120
VERIFICATION_POLL_INTERVAL=10
VERIFICATION_INITIAL_DELAY=10


# ─────────────────────────────────────────────────────────────────────────────
# HOME ASSISTANT INTEGRATION (Addon restarts, automation reloads)
# ─────────────────────────────────────────────────────────────────────────────
# Enables Jarvis to:
#   - Restart Home Assistant addons
#   - Reload automations, scripts, scenes
#   - Query entity states for context
#
# Create a Long-Lived Access Token:
#   Profile -> Security -> Long-Lived Access Tokens -> Create Token

HA_URL=http://localhost:8123
HA_SUPERVISOR_URL=http://supervisor/core
HA_TOKEN=


# ─────────────────────────────────────────────────────────────────────────────
# N8N INTEGRATION (Workflow orchestration, self-restart)
# ─────────────────────────────────────────────────────────────────────────────
# Enables Jarvis to:
#   - Trigger n8n workflows for complex multi-step remediations
#   - Use n8n for safe self-restart (self-preservation mechanism)
#
# For self-restart, import the workflow from:
#   configs/n8n-workflows/jarvis-self-restart-workflow.json

N8N_URL=http://localhost:5678
N8N_API_KEY=

# Webhook URL that triggers the self-restart workflow
N8N_SELF_RESTART_WEBHOOK=


# ─────────────────────────────────────────────────────────────────────────────
# SELF-PRESERVATION (Safe self-restart via n8n)
# ─────────────────────────────────────────────────────────────────────────────
# When Jarvis needs to restart itself or its dependencies (e.g., postgres-jarvis),
# it hands off to n8n to orchestrate the restart safely.
#
# JARVIS_EXTERNAL_URL: URL that n8n can reach to callback to Jarvis
#   - Must be reachable from wherever n8n runs
#   - Cannot be localhost if n8n is on a different host

JARVIS_EXTERNAL_URL=
SELF_RESTART_TIMEOUT_MINUTES=10
STALE_HANDOFF_CLEANUP_MINUTES=30


# ─────────────────────────────────────────────────────────────────────────────
# PROACTIVE MONITORING (Detect issues before alerts fire)
# ─────────────────────────────────────────────────────────────────────────────
# When enabled, Jarvis periodically checks for:
#   - Disk exhaustion trends (will disk fill in N hours?)
#   - Certificate expiration warnings
#   - Memory leak patterns
#   - Container resource issues

PROACTIVE_MONITORING_ENABLED=false
PROACTIVE_CHECK_INTERVAL=300

# Warn if disk will fill in less than this many hours
DISK_EXHAUSTION_WARNING_HOURS=24

# Warn if SSL cert expires in less than this many days
CERT_EXPIRY_WARNING_DAYS=30

# Memory growth rate threshold (MB per hour)
MEMORY_LEAK_THRESHOLD_MB_PER_HOUR=5.0


# ─────────────────────────────────────────────────────────────────────────────
# ANOMALY DETECTION (Statistical anomaly detection with auto-remediation)
# ─────────────────────────────────────────────────────────────────────────────
# When enabled, Jarvis uses Z-score based detection against 7-day baselines
# to identify anomalies in:
#   - Disk usage patterns
#   - Memory consumption
#   - CPU utilization
#   - Container restart frequency
#   - Network errors
#   - Disk I/O
#
# Sustained anomalies (3+ consecutive checks, ~15 min) trigger automatic
# remediation via synthetic alerts.

ANOMALY_DETECTION_ENABLED=false
ANOMALY_CHECK_INTERVAL=300
ANOMALY_COOLDOWN_MINUTES=30

# Z-score thresholds (standard deviations from mean)
# Warning: 3.0 = 99.7% confidence this is unusual
# Critical: 4.0 = 99.99% confidence this is unusual
ANOMALY_Z_SCORE_WARNING=3.0
ANOMALY_Z_SCORE_CRITICAL=4.0


# ═══════════════════════════════════════════════════════════════════════════════
# INTERNAL SETTINGS (Usually don't need to change)
# ═══════════════════════════════════════════════════════════════════════════════

# Database connection pool settings
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20

# Claude API settings
CLAUDE_MAX_TOKENS=4000
CLAUDE_TIMEOUT=60

# SSH connection settings
SSH_TIMEOUT=60
SSH_CONNECTION_TIMEOUT=10
